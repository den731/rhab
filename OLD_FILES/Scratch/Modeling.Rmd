---
title: "R Code"
output: pdf_document
---
\newpage

```{r setup, include=TRUE}

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)


#install.packages("RPostgreSQL")
#install.packages("tidyverse")
#install.packages("GGally")
#install.packages("viridis")
#install.packages("ggthemes")
install.packages("xtable")
#install.packages("RColorBrewer")
#install.packages("stargazer")
#install.packages("lme4")
#install.packages("leaps")
#install.packages("knitr")
#install.packages("rmarkdown")
#install.packages("cowplot")
#install.packages("FactoMineR")
#install.packages("factoextra")
#install.packages("missMDA")
#install.packages("texreg")
#install.packages("caret")
#install.packages("DAAG")
#install.packages("regclass")
#library(RPostgreSQL)

library(lme4)
library(tidyverse)
library(viridis)
library(ggthemes)
library(xtable)
library(readxl)
library(openxlsx)
library(stargazer)
library(leaps)
library(rmarkdown)
library(kableExtra)
library(leaps)
library(cowplot)
library(lubridate)
library(texreg)
library(car)
library(caret)
library(reshape2)
library(broom)
```

```{r Import Data and some Manipulated tables, include=FALSE}

# Load packages.
#detach(package:lme4)
library(leaps)
library(tidyverse)
library(car)
# Import data
zimported <- read.csv("MasterSheet.csv")

# NA are -999 so convert to NULL or NA
zimported[zimported==-999] <- NA 

# Mastersheet with some new variables and date converted to dates. 
Master_Sheet <- zimported %>% 
  select(-id) %>% # Dropping ID collumn 
  mutate(Dates = ymd(zimported$Date)) %>% 
  mutate(TN = NO3 + TKN) %>%
  mutate(TNTP = TN/TP)
  
#######################

# Import precipitation data and lake stations for each lake
# Imported from QGIS output
zghcnd <- read.csv("GHCND.csv")
zzghcnd <- read.csv("zzghcnd.csv")

# Join precip data to lake by station
zjoined <- zghcnd %>% 
  full_join(zzghcnd, by = c("STATION" = "station")) %>% 
  drop_na(lk_code)

# Filter out collumns and add dates and months
zNOAA <- zjoined %>% 
  select(date = DATE, prcp = PRCP, LK_CODE = lk_code, tobs = TOBS) %>%
  mutate(Dates = ymd(date)) %>%
  select(Dates, prcp, LK_CODE, tobs) %>%
  mutate(Months.rain = (month(Dates, label=TRUE, abbr = FALSE)))


#######################


# Ecoregion Import
ecoregion <- read.csv(file="ecoregion.csv")

# Lake information
Lake_info_comprehensive <- read.csv(file="Lake_info_comprehensive.csv")

# Import hobo logger data. 
# Each hobo loggers were compiled and averaged by each month

zHoboList <- list.files(path = "2017_HOBO/",
                        pattern = "*.csv",
                        full.names = T)
zhobomatrix <- data.frame(X1 = zHoboList) %>%
  mutate(filename_wo_ext = gsub(".csv","", X1))



yBEA <- read.csv(file="2017_HOBO/BEA.csv") 
zBEA <- yBEA %>%
  mutate(Date=vars(select(2)))
                                              
zBEL <- read.csv(file="2017_HOBO/BEL.csv")
zBEA <- read.csv(file="2017_HOBO/BEA.csv")
zBRI <- read.csv(file="2017_HOBO/BRI.csv") %>% mutate(Date=vars(select(2)),
                                                      Temp=vars(3),
                                                      Intensity=vars(4))

```


```{r}
zhobo <- read.csv(file="Hobo_MONTHLY.csv")

# Calculate land use percentages from Lake info sheet
info <- Lake_info_comprehensive %>% 
  rowwise() %>% 
  mutate(sum = sum(Water,Developed,Barren,Forest,Shrubs,
                   Herbaceous,Agriculture,Wetlands)) %>% 
  mutate_at(vars(Water:Wetlands), funs(./sum)) 

# Data Manipulation

# Order months by month instead of alphabetical. 
# Also calculate total Sum from SPATTS 
# Added a time interval for temporal joins

MonthOrdered <- as.data.frame(Master_Sheet) %>% 
  mutate(month = factor(month.name[Month], levels = month.name)) %>% 
  arrange(month) %>% 
  mutate_at(vars(
    S_D_Asp3_RR, S_MC_RR, S_Nodul,
    S_MC_YR, S_MC_HtyR, S_MC_LR,
    S_D_Asp3_RR, S_MC_HilR, S_MC_WR,
    S_MC_LA, S_MC_LY, S_MC_LW,
               S_MC_LF), funs(.*45/3)) %>% 
  # Converted spatts into nanogram per gram of resin
  rowwise() %>% 
  mutate(S_SUM = 
           sum(S_D_Asp3_RR, S_MC_RR, S_Nodul, 
               S_MC_YR, S_MC_HtyR, S_MC_LR,
               S_D_Asp3_RR, S_MC_HilR, S_MC_WR,
               S_MC_LA, S_MC_LY, S_MC_LW,
               S_MC_LF)) %>%
  mutate(fiveday = ymd(Dates - ddays(5)),
         threeday = ymd(Dates - ddays(3)),
         sevenday = ymd(Dates - ddays(7)) 
         ,thirtyday = ymd(Dates - ddays(30))) 

MonthOrdered[MonthOrdered==Inf] <- 0
  

  
  

#Precipitation Data Join
zRain <- full_join(MonthOrdered, 
                   zNOAA, 
                   by = c("LK_CODE" = "LK_CODE"))

#Filter rain data to match date ranges.
zNOAA3 <- zRain %>% rowwise() %>%
  filter(Dates.y >= as.Date(threeday) & 
         Dates.y <= as.Date(Dates.x))
zNOAA5 <- zRain %>% rowwise() %>% 
  filter(Dates.y >= as.Date(fiveday) &
         Dates.y <= as.Date(Dates.x))
zNOAA7 <- zRain %>% rowwise() %>% 
  filter(Dates.y >= as.Date(sevenday) &
         Dates.y <= as.Date(Dates.x))
zNOAA30 <- zRain %>% rowwise() %>% 
  filter(Dates.y >= as.Date(thirtyday) &
         Dates.y <= as.Date(Dates.x))

#Average by Day of sampling varied by lagged temprature dates. 
zzNOAA3 <- zNOAA3 %>% 
  group_by(LK_CODE, Mo) %>% 
  summarise(precip3 = mean(prcp, na.rm = TRUE),
            temp3 = mean(tobs, na.rm =TRUE))

zzNOAA5 <- zNOAA5 %>% 
  group_by(LK_CODE, Mo) %>% 
  summarise(precip5 = mean(prcp, na.rm = TRUE), 
            temp5 = mean(tobs, na.rm =TRUE))

zzNOAA7 <- zNOAA7 %>%
  group_by(LK_CODE, Mo) %>% 
  summarise(precip7 = mean(prcp, na.rm = TRUE), 
            temp7 = mean(tobs, na.rm =TRUE))

zzNOAA30 <- zNOAA30 %>% 
  group_by(LK_CODE, Mo) %>% 
  summarise(precip30 = mean(prcp, na.rm = TRUE),
            temp30 = mean(tobs, na.rm =TRUE))

# Surveyor information

zzsurveyor <- read.csv(file="surveyor.csv") 

#Ultimate Join of all tables
zUltimateSheet <- MonthOrdered %>%
  full_join(info,
            by = c("LK_CODE" = "LK_CODE")) %>%
  full_join(ecoregion, 
            by = c("LK_CODE" = "LK_CODE")) %>%
  full_join(zzNOAA3,
            by = c("LK_CODE" = "LK_CODE", "Mo" = "Mo")) %>%
  full_join(zzNOAA5,
            by = c("LK_CODE" = "LK_CODE", "Mo" = "Mo")) %>%
  full_join(zzNOAA7,
            by = c("LK_CODE" = "LK_CODE", "Mo" = "Mo")) %>%
  full_join(zzNOAA30, 
            by = c("LK_CODE" = "LK_CODE", "Mo" = "Mo")) %>%
  full_join(zhobo, 
            by = c("LK_CODE" = "LK_CODE", "Month" = "Month")) %>%
  full_join(zzsurveyor, 
            by = c("LK_CODE" = "LK_CODE")) %>%
  rename(hobotemp = TEMP, 
         hobolight = LIGH, 
         ecoregion = US_L3NAME) %>%
  mutate(LK_CODE = factor(LK_CODE),
         year = as.factor(year),
         network = factor(Network, levels = c("1", "2", "3", "4"),
                          exclude = TRUE),
         open = as.factor(Open_clos)) %>%
  rowwise() %>%
  filter_all(all_vars(!grepl('SUP',.))) %>% 
  # Omit all great lake sites. Lake Superior
  filter_all(all_vars(!grepl('ERI',.))) %>% 
  # Omit Lake Erie
  filter_all(all_vars(!grepl('STC',.))) %>% 
  # Omit Lake St. Clair
  filter_all(all_vars(!grepl('CUL',.))) %>% 
  # Omit Cullen Park 
  select(-county, -REACHCODE, -sum) 

  

# Convert all characters as factor
UltimateFactor <- as.data.frame(zUltimateSheet) %>% 
  mutate_if(is.character, as.factor) %>%
  mutate(surveyor = factor(surveyor, levels = c(1,2,3,4))) 
# Surveyors dummy variables as factor


# Modeling Log Transformed dataset. 
# Each variable is added by reportable detection limit
#Log transformed all data
LOGTransformed <- UltimateFactor %>% 
  mutate_at(vars(OP),
            funs(log10(.+0.003))) %>%
  mutate_at(vars(NO3), 
            funs(log10(.+0.04))) %>%
  mutate_at(vars(NH3),
            funs(log10(. + 0.006))) %>%
  mutate_at(vars(TP), 
            funs(log10(. + 0.002))) %>%
  mutate_at(vars(TKN),
            funs(log10(. + 0.07))) %>%
  mutate_at(vars(TN), 
            funs(log10(. + 0.116))) %>%
  mutate_at(vars(DO),
            funs(log10(. + 0.01))) %>%
  mutate_at(vars(turb, conduc),
            funs(log10(. + 0.01))) %>%
  mutate_at(vars(ELISA), 
            funs(log10(. + 0.15))) %>%
  mutate_at(vars(LkArea), 
            funs(log10(. + 1))) %>%
  mutate_at(vars(WtShArea), 
            funs(log10(. + 1))) %>%
  mutate_at(vars(phyco,chloro), 
            funs(log10(. + 0.01))) %>%
  mutate_at(vars(X16SRNA, CYANA, MCYE, CyrA, SxtA), 
            funs(log10(. + 20))) %>% 
  # qpcr results log transformed
  mutate_at(vars(Nodul:SUM), 
            funs(log10(. + 0.03))) %>% 
  # Mass Spec
  mutate_at(vars(Anatoxin:S_ELISA), 
            funs(log10(. + 1))) %>% 
  # SPATTS
  mutate_at(vars(precip3, precip5, precip7, 
                 precip30, hobolight), 
            funs(log10(.+1))) %>%
  # Drop variables not to be included in modeling
  select(-CYANA,-SxtA,-Sensored,-PPIA,-Sensored_1,
         -S_EL_CENS,-Dates, -month,
         -fiveday:-Network,-Open_clos,
         -Zebra,-network,
         -open, -Anatoxin, -Cylindro,-CyrA)


#Averaged by each lake, then log transformed
MCSUMresponseAverage <- UltimateFactor  %>%
  select(-CYANA,-SxtA,-Sensored,-PPIA,-Sensored_1,
         -S_EL_CENS,-Dates, -month,
         -fiveday:-Network,-Open_clos,
         -Zebra,-network,
         -open, -Anatoxin, -Cylindro,-CyrA) %>%
  group_by(LK_CODE) %>%
  summarise_all(funs(mean(., na.rm=TRUE))) %>%
  mutate_at(vars(OP), funs(log10(.+0.003))) %>%
  mutate_at(vars(NO3), funs(log10(.+0.04))) %>%
  mutate_at(vars(NH3), funs(log10(. + 0.006))) %>%
  mutate_at(vars(TP), funs(log10(. + 0.002))) %>%
  mutate_at(vars(TKN), funs(log10(. + 0.07))) %>%
  mutate_at(vars(TN), funs(log10(. + 0.116))) %>%
  mutate_at(vars(DO), funs(log10(. + 0.01))) %>%
  mutate_at(vars(turb, conduc), funs(log10(. + 0.01))) %>%
  mutate_at(vars(ELISA), funs(log10(. + 0.15))) %>%
  mutate_at(vars(LkArea), funs(log10(. + 1))) %>%
  mutate_at(vars(WtShArea), funs(log10(. + 1))) %>%
  mutate_at(vars(phyco,chloro), funs(log10(. + 0.01))) %>%
  mutate_at(vars(X16SRNA, MCYE), funs(log10(. + 20))) %>%
  mutate_at(vars(Nodul:SUM), funs(log10(. + 0.03))) %>% 
  #Mass Spec
  mutate_at(vars(S_D_Asp3_RR:S_SUM), funs(log10(. + 1))) %>% 
  # SPATTS
  mutate_at(vars(precip3, precip5, precip7,
                 precip30, hobolight), funs(log10(.+1))) %>%
  select(-LK_CODE:-doy, -Nodul:-MC_LF, 
         -ecoregion, -surveyor, -ELISA,
         -S_D_Asp3_RR:-S_ELISA)




```


\newpage

# Modeling
## Data Transformation and Normality Check


The distribution of our response variable will be checked and transformed to fit a normal distribution. 


```{r}
require(fitdistrplus)
X16SRNA <- LOGTransformed$X16SRNA %>% na.omit() %>% as.numeric()
SUM <- LOGTransformed$SUM %>% na.omit() %>% as.numeric()

```


\newpage

```{r}
par(mfrow=c(1,2)) 
plot(density(UltimateFactor$X16SRNA, na.rm = T), xlab = "16s rRNA Gene cp/mL of Sample",
     main = "A")
plot(density(LOGTransformed$X16SRNA, na.rm = T), xlab = "log10(X16SRNA+MDL)",
     main = "B")
```

```{r}
par(mfrow=c(1,2)) 
plot(density(UltimateFactor$SUM, na.rm = T), xlab = "SUM",
     main = "A")
plot(density(LOGTransformed$SUM, na.rm = T), xlab = "log10(SUM+MDL)",
     main = "B")

```

```{r}
fit.norm <- fitdist(SUM, "norm", method = "mle")
plot(fit.norm)
```


```{r}
detach("package:fitdistrplus")
detach("package:MASS")
require(lme4)
```


## Best Subset Selection



### MC Sum from grab sample as response
 


```{r,echo=TRUE}
Fullsubset <- regsubsets(SUM ~ .,
                    nbest = 5,
                    #force.in = "OP",
                    really.big = T,
                    method="exhaustive",
                    nvmax =3,
                    data=MCSUMresponseAverage)
```


```{r,fig.cap="Subset Analysis: Exhaustive Search on Full Dataset"}

setEPS()
postscript(file="Subset.eps")
plot(Fullsubset)

dev.off()

```


Each row is a model, if a variable is included in the model it is represented as a shaded rectangle. The BIC is plotted on the y axis where the lowest value is higher up on the axis. The better the model, the lower the BIC, thus the top rows are the better model. The frequency of the variables being included can also be important. The presence of one variable in the model and the effect of another variables presence/absence can also be important.  

###subset.eps

```{r}
zb <- summary(Fullsubset)
bic <- zb$bic
matrix <- zb$which 
rownames(matrix) <- bic
library(reshape2)
meltedz <- melt(matrix)
melted <- meltedz %>% filter(Var1 < -4.4790) 
ggplot(melted, aes(x= Var2, y = Var1, fill =  value)) +
  geom_tile() +
  scale_fill_manual(values = c("white", "black")) +
    theme(legend.position = "none",axis.text.x=element_text(size=5,angle = 45, hjust =1)) +
  scale_y_reverse() +
  ylab("BIC") +
  xlab("Predictor")
ggsave("Subset.eps", device = "eps")
```






\newpage



With all the best variables from regression subset analysis, variables will be tested by F-test and dropped when $\alpha > 0.05$. 


```{r, echo=TRUE}
FullModel <- lm(SUM~
               OP +
               MCYE +
               turb +
               TP,
             data=MCSUMresponseAverage)
###
Anova(FullModel)

```



\newpage

```{r}
Model1 <- lm(SUM~
               OP +
               MCYE +
               turb,
             data=MCSUMresponseAverage)

Anova(Model1)

```



```{r, include=FALSE}
Model <- lm(SUM~
               MCYE +
               turb,
             data=MCSUMresponseAverage)

Anova(Model)

```


```{r, include=FALSE}

Model <- lm(SUM~
               turb,
             data=MCSUMresponseAverage)

Anova(Model)
```

```{r}

zamod1 <- lm(turb~
               precip5,
             data=LOGTransformed)
summary(zamod1)
plot(LOGTransformed$turb~LOGTransformed$precip5)
Anova(zamod1)


```

```{r, include=FALSE}
zamod1 <- lm(SUM~
               TP,
             data=MCSUMresponseAverage)

Anova(zamod1)
summary(zamod1)
plot(zamod1)

```


```{r, include=TRUE}
zamod1 <- lm(SUM~
               OP +
               MCYE +
               turb,
             data=MCSUMresponseAverage)

abob <- Anova(zamod1)

kable(abob, digits=3)

```

Our last three variables are ortho-P, *mcyE*, turbidity

```{r,include=TRUE}
Model2 <- lm(SUM~
                 OP +
               MCYE +
               turb ,
             data=MCSUMresponseAverage)
abob <- Anova(Model2)

kable(abob, digits = 3)

```

Turbidity gets dropped

```{r,include=TRUE}
Model3 <- lm(SUM~
               MCYE +
               turb,
             data=MCSUMresponseAverage)
abob <- Anova(Model3)
kable(abob, digits=3)
```

```{r}
Model1 <- lmer(SUM~MCYE + (1|LK_CODE),
               data=LOGTransformed)
Model1 <- lmer(SUM~1 + (1|LK_CODE),
               data=LOGTransformed)
summary(Model1)
plot(LOGTransformed$SUM~LOGTransformed$MCYE)
Anova(Model1, test="F")
summary(Model1, stat.anova(test="F"))

Model1 <- lmer(SUM~turb +(1|LK_CODE),data=LOGTransformed, na.action = na.exclude)
Model2 <- lmer(SUM~turb + (1|LK_CODE),
               data=LOGTransformed)

plot(residuals(Model1)~LOGTransformed$doy)
abline(lm(residuals(Model1)~LOGTransformed$doy))


```

```{r}
Anova(Model2, test="F")
summary(Model2)
Model3 <- lmer(SUM~OP + (1|LK_CODE),
               data=LOGTransformed)

Model4 <- lmer(SUM~TP + (1|LK_CODE),
               data=LOGTransformed)
Model5 <- lmer(SUM~MCYE + turb + (1|LK_CODE),
               data=LOGTransformed)
Anova(Model5, test="F")
Model5 <- lmer(SUM~MCYE + turb + (1|LK_CODE),
               data=LOGTransformed)
Model6 <- lmer(SUM~turb + OP +(1|LK_CODE),
               data=LOGTransformed)
Model7 <- lmer(SUM~MCYE + OP + (1|LK_CODE),
               data=LOGTransformed)
Model8 <- lmer(SUM~MCYE + turb + OP + (1|LK_CODE),
               data=LOGTransformed)
Model9 <- lmer(SUM~OP + turb + TP + (1|LK_CODE),
               data=LOGTransformed)

qqmath(Model1)

AIC(Model1, Model2, Model3, Model4, Model5, Model6, Model7, Model8, Model9)
```



\newpage





    
    
    
```{r,fig.width=5, fig.height=5, fig.cap="MC Sum as a function of turbidity"}
## Get coeffient
cf <- round(coef(lm(SUM~turb, data=MCSUMresponseAverage)), 2) 
## Get equation
eq <- paste0("log(MC SUM) = ", cf[2], 
              "log(Turbidity) ", cf[1])
plot(MCSUMresponseAverage$SUM~MCSUMresponseAverage$turb, xlab="log(Turbidity)", ylab = "log(MC SUM)")
abline(lm(MCSUMresponseAverage$SUM~MCSUMresponseAverage$turb))
mtext(eq, 3, line=-2)
```

~    
  
    
    
\newpage
   
log(MC Sum) ~ log(Turbidity)
   
   
```{r,fig.width=5, fig.height=5,fig.cap="Residual Analysis of log(SUM) ~ log(Turbidity)"}
model1 <- lm(SUM~turb, data=MCSUMresponseAverage, na.action=na.omit)
layout(matrix(c(1,2,3,4),2,2))
plot(model1)
```


**The residuals is fairly normal. There is one data point that do seem to pull the correlation upward. **




\newpage

```{r,fig.width=5, fig.height=5,fig.cap="MC Sum as a function of mcyE"}
## Get coeffient
cf <- round(coef(lm(SUM~MCYE, data=MCSUMresponseAverage)), 2) 
## Get equation
eq <- paste0("log(MC Sum) = ", 
              abs(cf[2]), " log(mcyE) ", cf[1])
plot(MCSUMresponseAverage$SUM~MCSUMresponseAverage$MCYE, xlab="log(mcyE) ", ylab = "Log(MC Sum)")
abline(lm(MCSUMresponseAverage$SUM~MCSUMresponseAverage$MCYE))
mtext(eq, 3, line=-2)


```


`

\newpage


```{r, fig.width=5, fig.height=5,fig.cap="Residual Analysis of SUM ~ mcyE"}
model1 <- lm(SUM~MCYE, data=MCSUMresponseAverage, na.action=na.omit)
layout(matrix(c(1,2,3,4),2,2))
plot(model1)
```

**Residualis normal and seems fairly random. Variation is not uniformly scattered at the low and high end.**
\newpage

```{r,fig.width=5, fig.height=5, fig.cap="MC Sum as a function of ortho-P"}
## Get coeffient
cf <- round(coef(lm(SUM~OP, data=MCSUMresponseAverage)), 2) 
## Get equation
eq <- paste0("log10(MC Sum) = ", 
              abs(cf[2]), " log10(OP) +", cf[1])
plot(MCSUMresponseAverage$SUM~MCSUMresponseAverage$OP, xlab="log(ortho-P)", ylab = "log(MC Sum)")
abline(lm(MCSUMresponseAverage$SUM~MCSUMresponseAverage$OP))
mtext(eq, 3, line=-2)


```



\newpage

```{r,fig.width=5, fig.height=5, fig.cap="Residual Analysis of SUM~ortho-P"}
model1 <- lm(SUM~OP, data=MCSUMresponseAverage, na.action=na.omit)
layout(matrix(c(1,2,3,4),2,2))
plot(model1)
```

**ortho-P is driven by three signifigant outliers. **





\newpage

*Outliers are ommitted* 

log(MC Sum) ~ log(ortho-P)

```{r,fig.width=5, fig.height=5, fig.cap="MC Sum as a function of ortho-P with omitted outliers"}

omitted <- MCSUMresponseAverage %>%
  slice(c(-25,-4,-26))

## Get coeffient
cf <- round(coef(lm(SUM~OP, data=omitted)), 2) 
## Get equation
eq <- paste0("log(MC Sum) = ", 
              abs(cf[2]), " log(ortho-P) +", cf[1])

plot(omitted$SUM~omitted$OP, 
     xlab="log(ortho-P)",
     ylab = "log(SUM)")
abline(lm(omitted$SUM~omitted$OP))
mtext(eq, 3, line=-2)


```

`

\newpage

```{r,fig.width=5, fig.height=5,fig.cap="Residual Analysis of MC Sum ~ ortho-P with outliers removed"}
model1 <- lm(SUM~OP, data=omitted, na.action=na.omit)
summary(model1)
layout(matrix(c(1,2,3,4),2,2))
plot(model1)
```


```{r}
mab <- Anova(model1)
kable(mab, digits = 4)
```

**With Brighton, Silver, and Stony creek ommited, we see ortho-P signifigant effect on MC sum. However, the residual does not have a uniform variation.  **


\newpage



Lets assess each variable and see which one is the most signifigant by $\alpha$ value. 

```{r,include=TRUE}
Model4 <- lm(SUM~
               MCYE ,
             data=MCSUMresponseAverage)
abob <- Anova(Model4)
kable(abob, digits = 4)

```

```{r, include=TRUE}
Model5 <- lm(SUM~
               OP ,
             data=MCSUMresponseAverage)
abob <- Anova(Model5)
kable(abob, digits = 3)
```

```{r,include=TRUE}
Model6 <- lm(SUM~
               turb,
             data=MCSUMresponseAverage)
abob <- Anova(Model6)
kable(abob, digits = 3)
```

```{r,include=TRUE}
Model7 <- lm(SUM~
               Developed,
             data=MCSUMresponseAverage)
kable(Anova(Model7), digits = 3)
```

From here, our starting variable for a forward selection is *mcyE*

\newpage


```{r,include=TRUE}
Model <- lm(SUM~
              MCYE +
               OP,
             data=MCSUMresponseAverage)
kable(Anova(Model), digits = 3)
```

```{r,include=TRUE}
Model <- lm(SUM~
              MCYE +
               turb,
             data=MCSUMresponseAverage)
kable(Anova(Model), digits = 3)
```

```{r,include=TRUE}
Model <- lm(SUM~
              MCYE ,
             data=MCSUMresponseAverage)
kable(Anova(Model), digits = 3)
```

ortho-P is the second most signifigant

\newpage

```{r,include=TRUE}
Model <- lm(SUM~
              MCYE +
               OP ,
             data=MCSUMresponseAverage)
kable(Anova(Model), digits = 3)
```

```{r,include=TRUE}
Model <- lm(SUM~
              MCYE +
               OP +
              turb,
             data=MCSUMresponseAverage)
kable(Anova(Model), digits = 3)
```

Adding a third variable does not improve our model. SUM~OP+MCYE is most likely the best model.


\newpage


#### Best Model

```{r, include=FALSE}
FullModel <- lm(SUM~
               MCYE +
               turb +
                 OP,
             data=MCSUMresponseAverage)


Model1 <- lm(SUM~
               turb + 
               OP,
             data=MCSUMresponseAverage)


Model2 <- lm(SUM~
               MCYE +
               turb,
             data=MCSUMresponseAverage)


Model3 <- lm(SUM~
               turb +
               MCYE +
               OP,
             data=MCSUMresponseAverage)

Model4 <- lm(SUM~
               MCYE +
               OP,
             data=MCSUMresponseAverage)

Model5 <- lm(SUM~
               MCYE +
               OP,
             data=MCSUMresponseAverage)

Model6 <- lm(SUM~
               MCYE +
               turb,
             data=MCSUMresponseAverage)

Model7 <- lm(SUM~
               MCYE ,
             data=MCSUMresponseAverage)

Model8 <- lm(SUM~
               OP,
             data=MCSUMresponseAverage)

Model9 <- lm(SUM~
               turb,
             data=MCSUMresponseAverage)



Model10 <- lm(SUM~
                OP,
              data=MCSUMresponseAverage)

Model11 <- lm(SUM~
                turb,
              data=MCSUMresponseAverage)

Model12<- lm(SUM~ 
               MCYE,
             data=MCSUMresponseAverage)

Model13<- lm(SUM~
               OP +
               turb,
             data=MCSUMresponseAverage)



```


Each model is compared by BIC. All possible combination of models are listed here:

* FullModel = `r format(formula(FullModel))`

* Model 1 = `r format(formula(Model1))`

* Model 2 = `r format(formula(Model2))`

* Model 3 = `r format(formula(Model3))`

* Model 4 = `r format(formula(Model4))`

* Model 5 = `r format(formula(Model5))`

* Model 6 = `r format(formula(Model6))`

* Model 7 = `r format(formula(Model7))`

* Model 8 = `r format(formula(Model8))`

* Model 9 = `r format(formula(Model9))`

* Model 10 = `r format(formula(Model10))`

* Model 11 = `r format(formula(Model11))`

* Model 12 = `r format(formula(Model12))`

* Model 13 = `r format(formula(Model13))`



```{r, results='asis'}

zbic1 <- BIC(FullModel, Model1, Model2, Model3, Model4, Model5, Model6, Model7, Model8, Model9, Model10, Model11, Model12, Model13)

kable(zbic1, digits = 2)


```





* SUM ~ *mcyE* + turb is suggestably the best model. 


```{r}

summary(lm(SUM~MCYE + turb, data=MCSUMresponseAverage))

```

* SUM ~ turbidity + ortho-P + *mcyE*  is second best


```{r}

summary(lm(SUM~MCYE + turb + MCYE, data=MCSUMresponseAverage))

```









\newpage


### 16s rRNA gene as Response

```{r}

zFull2 <- regsubsets(X16SRNA ~.,
                     nbest=5,
                     nvmax=3,
                     really.big = T,
                    MCSUMresponseAverage, 
                    method = "exhaustive")

setEPS()
postscript(file="Subset1.eps")
plot(zFull2)
dev.off()
```


```{r}
zb <- summary(zFull2)
bic <- zb$bic
matrix <- zb$which 
rownames(matrix) <- bic
library(reshape2)
meltedz <- melt(matrix)
melted <- meltedz %>% filter(Var1 < -23.5334) 
ggplot(melted, aes(x= Var2, y = Var1, fill =  value)) +
  geom_tile() +
  scale_fill_manual(values = c("white", "black")) +
    theme(legend.position = "none",axis.text.x=element_text(size=5,angle = 45, hjust =1)) +
  scale_y_reverse() +
  ylab("BIC") +
  xlab("Predictor")
ggsave("Subset2.eps", device="eps")

```
## Linear Mixed Model


### Hypothesis test



```{r}
require(lme4)
setEPS()
plot(MCSUMresponseAverage$X16SRNA~MCSUMresponseAverage$Agriculture, xlab = "Percentage of Agriculture Land-use", ylab = "Log10(16S rRNA)")
abline(lm(X16SRNA~Agriculture, data=MCSUMresponseAverage))
postscript(file="Agriculture.eps")
dev.off()
```

# hypothes test thesis
```{r}
# hypothes test thesis
Model1<- lm(OP~Shrubs, data=MCSUMresponseAverage)
Anova(Model1) 
summary(Model1)
plot(Model1)

```

```{r}
# hypothes test thesis
Model1<- lmer(SUM~doy+I(doy^2) + (1|LK_CODE), data=LOGTransformed)
Anova(Model1, test.statistic = "F") 
summary(Model1)
plot(Model1)

Model1<- lm(X16SRNA~doy+I(doy^2) + TP , data=LOGTransformed)
anova(Model1)
plot(Model1)
```

```{r}
Model1<- lmer(OP~Agriculture + (1|LK_CODE), data=LOGTransformed)
Anova(Model1,test.statistic = "F") 
summary(Model1)
plot(Model1)
```

```{r}
Model1<- lmer(SUM~X16SRNA + (1|LK_CODE), data=LOGTransformed)
Anova(Model1,test.statistic = "F") 
summary(Model1)
plot(Model1)
```
####time1.eps
```{r}
# day of year test
setEPS()
postscript(file="time1.eps")
plot(LOGTransformed$doy,LOGTransformed$SUM, xlab = "Day of the year", ylab = "log(MC+0.03)")
Model1<-lm(SUM~doy+I(doy^2),data=LOGTransformed)
Model2<-lm(SUM~doy,data=LOGTransformed)
curve(coef(Model1)[1]+coef(Model1)[2]*x+coef(Model1)[3]*x^2,add=TRUE)
text(190, 0.5, "July")
text(220, 0.5, "August")
text(250, 0.5, "September")
text(280, 0.5, "October")
dev.off()
```


#### time2.eps



```{r}
# day of year test
setEPS()
postscript(file="time2.eps")
plot(LOGTransformed$doy,LOGTransformed$X16SRNA, xlab = "Day of the year", ylab = "log(X16SRNA+45)")
Model1<-lm(X16SRNA~doy+I(doy^2),data=LOGTransformed)
Model2<-lm(X16SRNA~doy,data=LOGTransformed)
curve(coef(Model1)[1]+coef(Model1)[2]*x+coef(Model1)[3]*x^2,add=TRUE)
text(190, 6, "July")
text(220, 6.6, "August")
text(260, 6, "September")
text(280, 6.6, "October")
dev.off()
```

#### SUM~DEVELOPED
```{r}
m1 <- lmer(SUM~Developed + (1|LK_CODE),
           data=LOGTransformed)
m2 <- lmer(SUM~TP + turb + (1|LK_CODE),
           data=LOGTransformed)
Anova(m1, test = "F")
summary(m1, ddf="Kenward-Roger")


```
#### Average with sd
```{r}
UltimateFactor %>% 
   group_by(Month) %>%
  #filter(Month=="7") %>%
  summarise(mean=mean(pH, na.rm=T), sd=sd(pH, na.rm=T))

require(reporttools)
UltimateFactor %>% 
  select(OP,NO3,NH3,TP,TKN) %>%
  tableContinuous()
```


```{r}
a<-lm(SUM~Developed, data=MCSUMresponseAverage)
summary(a)
```






```{r}
plot(LOGTransformed$doy,LOGTransformed$SUM, xlab = "Time (Day of Year)", ylab = "Log10(MC SUM)")
Model1<-lm(SUM~doy+I(doy^2),data=LOGTransformed)
Model2<-lm(SUM~doy,data=LOGTransformed)
curve(coef(Model1)[1]+coef(Model1)[2]*x+coef(Model1)[3]*x^2,add=TRUE)

```

```{r}
plot(LOGTransformed$doy,LOGTransformed$X16SRNA, xlab = "Time (Day of Year)", ylab = "Log10(16S rRNA)")
Model1<-lm(X16SRNA~doy+I(doy^2),data=LOGTransformed)

curve(coef(Model1)[1]+coef(Model1)[2]*x+coef(Model1)[3]*x^2,add=TRUE)

```

```{r}
plot(LOGTransformed$doy,LOGTransformed$S_ELISA, xlab = "Time (Day of Year)", ylab = "Log10(MCYE)")
Model1<-lm(S_SUM~doy+I(doy^2),data=LOGTransformed)

curve(coef(Model1)[1]+coef(Model1)[2]*x+coef(Model1)[3]*x^2,add=TRUE)

```




### Models factoring in day of year

```{r}
model1 <- lmer(SUM~I(doy-mean(doy))+I((doy-mean(doy))^2) + OP
               + (1|LK_CODE), 
               data=LOGTransformed)
model2 <- lmer(SUM~I(doy-mean(doy))+I((doy-mean(doy))^2)
               + (1|LK_CODE), 
               data=LOGTransformed)
model3 <- lmer(SUM~OP
               + (1|LK_CODE), 
               data=LOGTransformed)
model4 <- lmer(SUM~OP
               + (1|surveyor), 
               data=LOGTransformed)
model5 <- lmer(SUM~I(doy-mean(doy))+I((doy-mean(doy))^2)
               + (1|surveyor), 
               data=LOGTransformed)
Anova(model1,test="F")
Anova(model2,test="F")
plot(model2)
Anova(model3,test="F")

BIC(model1, model2, model3, model4, model5)
```


```{r}
Model1 <- lm(X16SRNA~Forest,
             data=LOGTransformed)
plot(Model1$model$X16SRNA~Model1$model$Forest)
plot(LOGTransformed$X16SRNA~LOGTransformed$Forest)
abline(lm(LOGTransformed$X16SRNA~LOGTransformed$Forest))
```




```{r}
Model1 <- lmer(SUM~pH + (1|LK_CODE),
               data=LOGTransformed)
summary(Model1)
Anova(Model1, test="F")
```

```{r, echo=TRUE}
library(lme4)
Model1 <- lmer(SUM~
                 MCYE + 
                 OP + 
                 
                 (1|LK_CODE),
               data=LOGTransformed)
summary(Model1)

Model2 <- lmer(SUM~
                 MCYE +
                 OP +
                 (1|LK_CODE),
               data=LOGTransformed)

Model3 <- lmer(SUM~
                 OP +
                 (1|LK_CODE),
               data=LOGTransformed)

Model4 <- lmer(SUM~
                 Developed +
                 (1|LK_CODE),
               data=LOGTransformed)

Model5 <- lmer(SUM~
                 MCYE + 
                 OP +
                 I(doy^2) + 
                 (1|LK_CODE),
               data=LOGTransformed)

Model6 <- lmer(SUM~
                 OP +
                 I(doy-mean(doy)) + 
                 I((doy-mean(doy))^2) +
                 (1|LK_CODE),
               data=LOGTransformed)

Model7 <- lmer(SUM~
                 MCYE +
                 I(doy-mean(doy)) + 
                 I((doy-mean(doy))^2) +
                 (1|LK_CODE),
               data=LOGTransformed)
Model8 <- lm(SUM~
                 MCYE +
                 OP,
               data=LOGTransformed)

summary(Model1)
  

stargazer(Model1,Model2, Model3, Model4, Model5, Model6, Model7, Model8)




```

```{r}
zxymod <- lm(SUM~doy + I(doy^2), data=LOGTransformed)
zcoef <- coef(zxymod)
plot(LOGTransformed$doy, LOGTransformed$SUM)

curve(coef(zxymod)[1] + 
        coef(zxymod)[2]*x +
        coef(zxymod)[3]*x^2, 
      add=TRUE)


model2 <- lmer(SUM~doy + (1|LK_CODE), data=LOGTransformed)
model3 <- lmer(SUM~doy + I(doy^2) + (1|LK_CODE), data=LOGTransformed)


plot(model1)

summary(model2)

AIC(model2)
BIC(model3, model2)
      
anova(model3, model2)
stargazer(model1, model2, model3)
```

```{r}
zxymod <- lm(SUM~doy + I(doy^2), data=LOGTransformed)
zcoef <- coef(zxymod)
plot(LOGTransformed$doy, LOGTransformed$SUM)

curve(coef(zxymod)[1] + 
        coef(zxymod)[2]*x +
        coef(zxymod)[3]*x^2, 
      add=TRUE)


```

\newpage


```{r}
Model1 <- lmer(SUM~X16SRNA +
                 (1|LK_CODE),
               data=LOGTransformed)
Anova(Model1, test="F")
summary(Model1)
          
plot(Model1)       
Model1<-lm(SUM~X16SRNA , data=MCSUMresponseAverage)
plot(MCSUMresponseAverage$SUM~MCSUMresponseAverage$X16SRNA)
abline(Model1)
```



# Thesis Figures


## Boxplots

## congenerbar.eps

```{r}
library(latex2exp)
congenerssz <- UltimateFactor %>% 
  select(Nodul:ELISA) %>%
  gather(Congener, Concentrations, Nodul:MC_LF) %>%
  select(Congener, Concentrations)
 



congenerssz %>%
  ggplot(aes(x=Congener, y=Concentrations, width=0.3)) +
  stat_summary(fun.y=mean, geom = "bar", fill=
                                                                  "white",
                                                                   na.rm = T,
                                                                color=
                                                                "black") + theme_cowplot() +
 
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.4)) +
  scale_x_discrete(label=c( "[D-Asp3] MC-LR", "[D-Asp3] MC-RR",   "MC-HilR", "MC-HtyR","MC-LA", "MC-LF", "MC-LR", "MC-LW", "MC-LY","MC-RR", "MC-WR", "MC-YR", "Nodularin")) +
  ylab(TeX('Average MC ($\\mu$g/L)'))
ggsave("congenerbar.eps", device = "eps" )
```



## barspatts.eps

```{r}
 UltimateFactor %>% 
  gather(Congener, Concentrations, S_D_Asp3_RR:S_MC_LW) %>%
  ggplot(aes(Congener,Concentrations )) + stat_summary(fun.y=mean, geom = "bar", fill=
                                                                  "white",
                                                                   na.rm = T,
                                                                color=
                                                                "black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  
  xlab("Congeners") +
  ylab("Concentrations (ng of MC / g of resin)") +
   
    scale_x_discrete(label=c( "[D-Asp3] MC-RR","[D-Asp3] MC-LR",    "MC-HilR", "MC-HtyR","MC-LA", "MC-LR",  "MC-LW", "MC-LY","MC-RR", "MC-WR", "MC-YR", "Nodularin")) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.4)) 
 ggsave("barspatts.eps", device="eps")

```


\newpage








```{r}
model1 <- lm(X16SRNA~Agriculture,
             data = LOGTransformed)

plot(model1)

summary(model1)
Anova(model1)
plot(LOGTransformed$X16SRNA~LOGTransformed$Agriculture)
abline(lm(LOGTransformed$X16SRNA~LOGTransformed$Agriculture))
```




## barmcsum.eps

```{r}

UltimateFactor  %>%  ggplot(aes(LK_CODE,SUM )) + stat_summary(fun.y=mean, geom = "bar", fill=
                                                                  "white",
                                                                   na.rm = T,
                                                                color=
                                                                "black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.4)) +
  xlab("Lake Site") +
  ylab("MC Sum (ppb)")
ggsave("barmcsum.eps", device="eps")
```




## bar16srna.eps

```{r}

UltimateFactor  %>%  ggplot(aes(LK_CODE,S_SUM )) + stat_summary(fun.y=mean, geom = "bar", fill=
                                                                  "white",
                                                                   na.rm = T,
                                                                color=
                                                                "black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.4)) +
  xlab("Lake Site") +
  ylab("16S rRNA (Genecopies/mL)")
ggsave("bar16srna.eps", device="eps")
```


Congener by Latitude

```{r 22, warning=FALSE, echo = FALSE}
cong_sum <- UltimateFactor %>% gather(congener, percentage, Nodul:MC_LF)



cong_1 %>% ggplot(aes(x=Lat, y=percentage, fill=congener, width=0.1)) + geom_bar(stat="identity")  + scale_fill_viridis(discrete=TRUE, option="B"
                                                                                                                        ,label=c( "[D-Asp3] MC-LR", "[D-Asp3] MC-RR",   "MC-HilR", "MC-HtyR","MC-LA", "MC-LF", "MC-LR", "MC-LW", "MC-LY","MC-RR", "MC-WR", "MC-YR", "Nodularin")
                                                                                                                        
                                                                                                                        ) + 
  #scale_y_continuous(limits = c(0,100)) + 
  coord_flip() + theme_classic()

```




Congener boxlplot proportions by each LK CODE

```{r 2, warning=FALSE, echo = FALSE}

cong_sp <- MonthOrdered %>%
  select(LK_CODE, S_D_Asp3_RR:S_ELISA) %>% 
  group_by(LK_CODE) %>% summarise_all(funs(mean(.,na.rm = TRUE)))
  
cong_sum_sp <- LOGTransformed %>% gather(congener, percentage, S_D_Asp3_RR:S_MC_LF)
cong_sum_sp %>% 
  ggplot(aes(x=LK_CODE, y=percentage, fill=congener)) + theme_classic() + 
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))   +
  geom_bar(stat="identity") + 
  scale_fill_viridis(discrete=TRUE, option="B",label=c( "[D-Asp3] MC-LR", "[D-Asp3] MC-RR",   "MC-HilR", "MC-HtyR","MC-LA", "MC-LF", "MC-LR", "MC-LW", "MC-LY","MC-RR", "MC-WR", "MC-YR", "Nodularin")) + xlab("Lake")  #labs(title="Congeners % by Lake from SPATTS", fill="Congener") + 
 

```




## Tables Grabsamples



```{r, results='asis', echo=FALSE}
third <- UltimateFactor %>%
  select(Nodul:ELISA)
stargazer(as.data.frame(third), header=FALSE, covariate.labels = c("Nodularin", "{[D-Asp3]}MC-RR", "MC-RR", "MC-YR", "MC-HtyR", "MC-LR", "{[D-Asp3]}MC-LR", "MC-HilR", "MC-WR", "MC-LA", "MC-LY","MC-LW", "MC-LF", "MC Sum from LC MS/MS ", "MC from ELISA"), notes = "Values are expressed as($\\mu$g of MC*${L^{-1}}$)", notes.align = "r")

```


SPATTS 


```{r, results='asis', warning = FALSE, echo=FALSE, message=FALSE}
fourth <- MonthOrdered %>%
  select(39:53)
stargazer(as.data.frame(fourth), header=FALSE, digits = 0,  covariate.labels = c("{[D-Asp3]}MC-RR", "MC-RR", "Nodularin", "MC-YR", "MC-HtyR", "MC-LR", "{[D-Asp3]}MC-LR", "MC-HilR", "MC-WR", "MC-LA", "MC-LY","MC-LW", "MC-LF", "MC Sum from LC MS/MS", "MC from ELISA"),  notes = "Values are expressed as (ng of MC / gram of resin)", notes.align = "r")

```


##  TABLE Nutrients


```{r, results='asis', echo=FALSE}

stargazer(as.data.frame(first.half), header=FALSE, covariate.labels = c(" Orthophosphate (mg P/L)","Nitrate+Nitrite (mg N/L)", "Ammonia (mg N/L) ", "Total Phosphorus (mg P/L)", "Total Kjeldahl Nitrogen (mg N/L)", "Total Nitrogen"))

```


## TABLE QPCR 



```{r,warning = FALSE, echo=FALSE, message=FALSE, header=FALSE, results='asis'}
second <- UltimateFactor %>%
  select("X16SRNA", MCYE:SxtA)
stargazer(as.data.frame(second), header = FALSE,  digits = 0, covariate.labels = c("16S rRNA", "mcyE", "cyrA", "sxtA"), notes = "* Values are expressed as Gene copies/$\\mu$L", notes.align = "r" )

```

## Barplot Nutrients nutboxlake

```{r}
 
  
A <-  UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=OP)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

B <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=NO3)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

C <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=NH3)) + 
stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

D <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=TP)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

E <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=TKN)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

F <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=TN)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

plot_grid(A,B,C,D,E,F,labels = c("A", "B", "C","D","E", "F"), align = "v", ncol = 2)
ggsave("nutboxplotlake.eps",height = 9 , units = "in", device="eps")
```

## watboxplotlake
```{r}
A <-  UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=pH)) + 
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

B <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=conduc)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

C <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=turb)) + 
stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")

D <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, DO)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ")



plot_grid(A,B,C,D,labels = c("A", "B", "C","D"), align = "v", ncol = 2)
ggsave("watboxplotlake.eps",height = 9, units = "in", device="eps")

```



## spatttboxplotlake.eps

```{r}
A <-  UltimateFactor %>%
  ggplot(aes(x=LK_CODE, y=SUM)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab(" ") +
  ylab("MC (ppb)")

B <- UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=S_SUM)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab("Lake Site") +
  ylab("MC in ng / g of resin ")
C <-  UltimateFactor %>% 
  mutate(Lat=as.factor(round(Lat,2))) %>%
  ggplot(aes(x=Lat, y=SUM)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab("") +
  ylab(" ")

D <- UltimateFactor %>% 
  mutate(Lat=as.factor(round(Lat,2))) %>%
  ggplot(aes(x=Lat, y=S_SUM)) + 
  stat_summary(fun.y=mean, geom = "bar", fill="white",
               na.rm = T,
               color="black") + theme_cowplot() +
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.5) + 
  theme(axis.text.x = element_text(angle = 90, size = 7, vjust = 0.4)) +
  xlab("Latitude") +
  ylab(" ")
plot_grid(A,C,B,D, labels ="AUTO", align = "v", ncol = 2, hjust = -0.1)
ggsave("spatttboxplotlake.eps", device="eps")

```



```{r boxlake1, warning=FALSE, echo=FALSE}
zpzpzpz <- MonthOrdered 

#install.packages("latex2exp")
require(latex2exp)



UltimateFactor %>% 
  ggplot(aes(x=LK_CODE, y=(SUM))) + geom_point(aes(x=LK_CODE, y= SUM, color="SUM"), size=2, alpha=0.5) + geom_point(aes(x=LK_CODE, y=(ELISA), color="ELISA"), size = 2, alpha=0.5) +  theme_classic() + ylab(TeX('$\\mu$g/L of MC')) + xlab( "Lakes") + labs(title="Microcystin") + theme(legend.title=element_blank(), legend.position="bottom", axis.text.x = element_text(angle = 90, size = 6, vjust = 0.4)) + geom_hline(yintercept = 4, color="#BB0000", linetype="dashed", show.legend = FALSE) +  geom_text(aes(17,4.9, label = "EPA Guideline"), color="#BB0000", show.legend=FALSE) + scale_color_manual(labels = c("MC from ELISA", "MC from LC-MS/MS"), values = c("green", "black"))

```

## Microcystin Time


```{r}
UltimateFactor %>%
  ggplot(aes(x=month,y=SUM)) + geom_boxplot()

UltimateFactor %>% group_by(month) %>%
  #filter(month=="July") %>%
  summarise(mean=mean(SUM, na.rm=TRUE))
```

## Correlation matrix

```{r}

cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation

p.mat<-cor.mtest(MCSUMresponseAverage)

corrtable <- round(cor(MCSUMresponseAverage, use="complete.obs"),1)

# generate graphics
library(corrplot)
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot.mixed(corrtable, 
               lower = "number",
               lower.col = "black",
               tl.pos = "lt",
               tl.col="black", 
               tl.srt=45, 
               tl.cex=0.6,
               order="AOE",
               number.font =1.25,
               sig.level=0.05,
               p.mat=p.mat,
               insig = "blank",
               diag = "n", 
               mar=c(0,0,1,0),
               number.cex= 0.381)
dev.off()
```





